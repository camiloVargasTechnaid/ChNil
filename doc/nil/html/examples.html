<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>ChibiOS/NIL: Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ChibiOS/NIL
   &#160;<span id="projectnumber">2.0.0</span>
<script type="text/javascript"><!--
google_ad_client = "pub-3840594581853944";
/* Documentation, bottom, 728x90, created 9/19/10 */
google_ad_slot = "1902290615";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('examples.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Examples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>ChNil Examples</p>
<ul>
<li><a class="el" href="examples.html#genComment">Understanding the Examples</a></li>
<li><a class="el" href="examples.html#ChNilBlink">Two Thread Blink</a></li>
<li><a class="el" href="examples.html#ChNilBlinkPrint">Blink Print</a></li>
<li><a class="el" href="examples.html#ChNilContextSwitch">Scope Context Switch Test</a></li>
<li><a class="el" href="examples.html#ChNilAdc">Demo of chAnalogRead</a></li>
<li><a class="el" href="examples.html#ChNilEvent">Example of ChNil event flags.</a></li>
<li><a class="el" href="examples.html#ChNilInterrupt">Interrupt Service Routine</a></li>
<li><a class="el" href="examples.html#ChNilMailbox">ChNil Mailbox Demo</a></li>
<li><a class="el" href="examples.html#ChNilMemPool">ChNil Memory Pool Demo</a></li>
<li><a class="el" href="examples.html#ChNilSdLogger">Mailbox Based SD Data Logger</a></li>
<li><a class="el" href="examples.html#ChNilSemaphore">Counting Semaphore</a></li>
<li><a class="el" href="examples.html#ChNilTemplate1">Template for One Thread</a></li>
<li><a class="el" href="examples.html#ChNilTemplate2">Template for Two Threads</a></li>
<li><a class="el" href="examples.html#ChNilTemplate3">Template for Three Threads</a></li>
<li><a class="el" href="examples.html#ChNilTestSem">Test of Semaphore Functions</a></li>
<li><a class="el" href="examples.html#ChNilTimer1">Test of ChNilTimer1</a></li>
<li><a class="el" href="examples.html#ChNilTwiSleepTest">TwiMaster Sleep Test</a></li>
</ul>
<h1><a class="anchor" id="genComment"></a>
Understanding the Examples</h1>
<p>This section describes features common to all ChNil examples. </p>
<h2><a class="anchor" id="extraLibraries"></a>
Extra Libraries</h2>
<p>Two additional libraries are included in the extras folder. The ChNilSdLogger.ino example requires the SdFat library and the ChNilTwiSleepTest.ino example requires the TwiMaster library.</p>
<p>The versions of the SdFat and TwiMaster libraries use during development of ChNil are included in the extras folder and must be moved to your libraries folder if you run these examples.</p>
<h2><a class="anchor" id="threadDef"></a>
Definition of Threads</h2>
<p>A thread is defined by three macros, <a class="el" href="group___n_i_l___k_e_r_n_e_l.html#gae444c4dea8c57ead8e7b5d22b1659c48" title="Static working area allocation. ">THD_WORKING_AREA()</a>, <a class="el" href="group___n_i_l___k_e_r_n_e_l.html#ga7c3e2a5577d0673aec643a933ec9b325" title="Thread declaration macro. ">THD_FUNCTION()</a>, and <a class="el" href="group___n_i_l___k_e_r_n_e_l.html#gaeac8d5d7858395210bfd063e1a5721c2" title="Entry of user threads table. ">THD_TABLE_ENTRY()</a>.</p>
<p>The working area for a thread is declared by this statement. The name of the working area is "waThread1" and its stack has 128 bytes beyond context switch and interrupt needs. </p><div class="fragment"><div class="line"><a class="code" href="group___n_i_l___k_e_r_n_e_l.html#gae444c4dea8c57ead8e7b5d22b1659c48">THD_WORKING_AREA</a>(waThread1, 128);</div>
</div><!-- fragment --><p>The entry point for a thread named Thread1 is declared by this statement. The thread function, Thread1, will be started with the argument "void *arg". </p><div class="fragment"><div class="line"><a class="code" href="group___n_i_l___k_e_r_n_e_l.html#ga7c3e2a5577d0673aec643a933ec9b325">THD_FUNCTION</a>(Thread1, arg)</div>
</div><!-- fragment --><p>The THD_TABLE_ENTRY macro defines a thread table entry. The thread table is used by the ChNil scheduler.</p>
<p>The priority of a thread is determined by its position in the thread table with highest priority first.</p>
<p>This is the thread table entry for a thread named "thread1" with entry point "Thread1". The thread is started with a NULL argument and has "waThread1" as its working area.</p>
<div class="fragment"><div class="line"><a class="code" href="group___n_i_l___k_e_r_n_e_l.html#gaeac8d5d7858395210bfd063e1a5721c2">THD_TABLE_ENTRY</a>(waThread1, <span class="stringliteral">&quot;thread1&quot;</span>, Thread1, NULL)</div>
</div><!-- fragment --> <h2><a class="anchor" id="idleThread"></a>
The Idle Thread</h2>
<p>ChNil runs a special thread called the idle thread when all user defined threads are blocked. The idle thread is therefore the lowest priority thread.</p>
<p>The idle thread must not invoke any kernel primitive able to change a thread's state to not runnable.</p>
<p>The ChNil Arduino library runs the loop() function in the idle thread when all other threads are blocked.</p>
<h2><a class="anchor" id="nilScheduler"></a>
The Nil Scheduler</h2>
<p>The ChNil scheduler is a fixed priority preemptive scheduler.</p>
<p>The scheduling strategy is very simple, the currently ready thread with the highest priority is executed.</p>
<p>A thread's priority is determined by its position in the thread table with highest priority first.</p>
<p>Higher priority threads must block to allow lower priority threads to execute. A thread can block by waiting on a semaphore, event, mailbox, or sleeping.</p>
<h2><a class="anchor" id="stackMsg"></a>
Stack Usage Messages</h2>
<p>The <a class="el" href="group___ch_nil.html#ga88d413176a9b1e5e2d1c7525169460d2">chFillStacks()</a> function fills stack areas with a 0X55 pattern so that the "high water mark" can be determined for all stacks.</p>
<p>The <a class="el" href="group___ch_nil.html#gac16c4f9dcb6567b43e2e301f556e9eb8">chPrintUnusedStack()</a> function prints a message of this form. </p><pre class="fragment">Unused Stack: 57 28 1663
</pre><p> This message indicates that the first thread in the thread table has 57 unused bytes of stack, the second thread has 28 bytes of unused stack, and the idle thread has 1663 bytes of unused stack.</p>
<p>The <a class="el" href="group___ch_nil.html#ga882a73e269554200e6415be8eeb0921d">chPrintStackSizes()</a> function prints a message of this form. </p><pre class="fragment">Stack Sizes: 133 101 85 1614
</pre><p> This message indicates that the first thread in the thread table started with a total stack size of 133 bytes, the second thread started with 101 bytes, the third thread started with 85 bytes, and the total stack space for the idle thread is 1614 bytes.</p>
<h1><a class="anchor" id="nilExamples"></a>
Examples</h1>
<p>The following examples are in the ChNil/examples folder.</p>
<h2><a class="anchor" id="ChNilBlink"></a>
Two Thread Blink</h2>
<p>The ChNilBlink.ino example demonstrates thread definition, semaphores, and thread sleep.</p>
<p>Thread 1 waits on a semaphore and turns the LED off when signalled by thread 2.</p>
<p>Thread 2 turns the LED on, sleeps for a period, signals thread 1 to turn the LED off, and sleeps for another period.</p>
<h2><a class="anchor" id="ChNilBlinkPrint"></a>
Blink Print</h2>
<p>The ChNilBlinkPrint.ino example demonstrates thread definition, thread sleep, the idle thread, concurrent access to a variable, and ChNilSerial.</p>
<p>Thread 1 blinks the LED and sleeps between LED state changes.</p>
<p>Thread 2 prints a message once a second. The message has the value of a counter that is incremented in the idle thread and the amount of unused stack for each thread.</p>
<p>The idle thread increments a counter in a critical section.</p>
<h2><a class="anchor" id="ChNilContextSwitch"></a>
Scope Context Switch Test</h2>
<p>The ChNilContextSwitch.ino example demonstrates the time require for a semaphore signal plus a thread context switch.</p>
<p>To use this example, connect a scope to pin 13.</p>
<p>Measure the difference in time between the first pulse with no context switch and the second pulse started in thread 2 and ended in thread 1. The difference should be about 12 usec on a 16 MHz 328 Arduino.</p>
<h2><a class="anchor" id="ChNilEvent"></a>
Example of ChNil event flags.</h2>
<p>The ChNilEvent.ino example demonstrates an event listener and two event source threads.</p>
<h2><a class="anchor" id="ChNilInterrupt"></a>
Interrupt Service Routine</h2>
<p>The ChNilInterrupt.ino example demonstrates a handler thread triggered from an ISR by using a semaphore.</p>
<p>The a pin change interrupt is generated by thread 2. Thread 2 prints a "High" message, set the pin high, prints a "Low" message and sets the pin low.</p>
<p>The pin going high triggers an interrupt that invokes the pin change ISR. The pin change ISR stores the time in micros() and signals a handler thread with a semaphore.</p>
<p>Thread 1, the handler thread prints message with the interrupt response time. This message should occur between the "High" and "Low" messages from thread 2.</p>
<h2><a class="anchor" id="ChNilMailbox"></a>
ChNil Mailbox Demo</h2>
<p>The ChNilMailbox.ino example demonstrates the use of mailboxes to implement simple queues.</p>
<h2><a class="anchor" id="ChNilMemPool"></a>
ChNil Memory Pool Demo</h2>
<p>The ChNilMemPool.ino example demonstrates use of memory pools and mailboxes.</p>
<h2><a class="anchor" id="ChNilSdLogger"></a>
Mailbox Based SD Data Logger</h2>
<p>The ChNilSdLogger.ino example is a complete SD data logger using mailboxes, <a class="el" href="group___timer1.html#ga4056d8fbf49495814e28356097f0b889">chTimer1Wait()</a>, and <a class="el" href="group___ch_nil_adc.html#gaad6d3ef0991385540dff929ced68c495">chAnalogRead()</a>.</p>
<p>ChNilSdLogger is structured as a starting point for a custom data logger.</p>
<p>A quality SD card is required for best performance. Adjust these constants to match your SD card.</p>
<div class="fragment"><div class="line"><span class="comment">// Time between points in microseconds.</span></div>
<div class="line"><span class="comment">// Maximum value is 4,194,304 (2^22) usec.</span></div>
<div class="line"><span class="keyword">const</span> uint32_t PERIOD_USEC = 250;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Number of ADC channels to log</span></div>
<div class="line"><span class="keyword">const</span> uint8_t NADC = 2;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Number of mailbox slots.</span></div>
<div class="line"><span class="preprocessor">#define NUM_BUFFERS 200</span></div>
</div><!-- fragment --><h2><a class="anchor" id="ChNilSemaphore"></a>
Counting Semaphore</h2>
<p>The ChNilSemaphore.ino demonstrates limiting access to a region of code by using a counting semaphore.</p>
<p>The example has three threads but only allows two threads to access the restricted region.</p>
<h2><a class="anchor" id="ChNilTemplate1"></a>
Template for One Thread</h2>
<p>The ChNilTemplate1.ino example is a template for one normal thread plus the idle thread. The template prints stack sizes and unused stack space.</p>
<h2><a class="anchor" id="ChNilTemplate2"></a>
Template for Two Threads</h2>
<p>The ChNilTemplate1.ino example is a template for two normal threads plus the idle thread. The template prints stack sizes and unused stack space.</p>
<h2><a class="anchor" id="ChNilTemplate3"></a>
Template for Three Threads</h2>
<p>The ChNilTemplate1.ino example is a template for three normal threads plus the idle thread. The template prints stack sizes and unused stack space.</p>
<h2><a class="anchor" id="ChNilAdc"></a>
Demo of chAnalogRead</h2>
<p>the ChNilAdc.ino example is a simple test that compares Arduino analogRead() with <a class="el" href="group___ch_nil_adc.html#gaad6d3ef0991385540dff929ced68c495">chAnalogRead()</a>.</p>
<p>The test verifies that <a class="el" href="group___ch_nil_adc.html#gaad6d3ef0991385540dff929ced68c495">chAnalogRead()</a> sleeps while ADC conversion is in progress.</p>
<p><a class="el" href="group___ch_nil_adc.html#gaad6d3ef0991385540dff929ced68c495">chAnalogRead()</a> allows lower priority threads to execute while the ADC is busy.</p>
<h2><a class="anchor" id="ChNilTestSem"></a>
Test of Semaphore Functions</h2>
<p>The nilSemTest.ino example tests semaphore functions. It a quality assurance tests for the ChNil library and can be ignored by most users.</p>
<h2><a class="anchor" id="ChNilTimer1"></a>
Test of ChNilTimer1</h2>
<p>ChNilTimer1.ino is a very simple test to verify ChNilTimer1 works as expected.</p>
<h2><a class="anchor" id="ChNilTwiSleepTest"></a>
TwiMaster Sleep Test</h2>
<p>ChNilTwiSleepTest.ino is a test to verify that threads sleep while I2C transfers occur. It prints the percent of time save for other threads by using the TwiMaster library in place of the standard Wire library. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jan 16 2017 07:15:55 for ChibiOS/NIL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
